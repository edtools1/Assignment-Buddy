{\rtf1\ansi\ansicpg1252\cocoartf2822
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fswiss\fcharset0 Helvetica;}
{\colortbl;\red255\green255\blue255;}
{\*\expandedcolortbl;;}
\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural\partightenfactor0

\f0\fs24 \cf0 <!DOCTYPE html>\
<html lang="en" class="h-full bg-gray-100">\
<head>\
    <meta charset="UTF-8">\
    <meta name="viewport" content="width=device-width, initial-scale-1.0">\
    <title>Assignment Tracker</title>\
    <!-- PWA Meta Tag -->\
    <meta name="theme-color" content="#3b82f6">\
    <!-- PWA Manifest Link -->\
    <link rel="manifest" href="manifest.json">\
    <!-- Load Tailwind CSS -->\
    <script src="https://cdn.tailwindcss.com"></script>\
    <style>\
        /* Custom scrollbar for a cleaner look */\
        #assignment-list::-webkit-scrollbar \{\
            width: 6px;\
        \}\
        #assignment-list::-webkit-scrollbar-track \{\
            background: #f1f1f1;\
            border-radius: 10px;\
        \}\
        #assignment-list::-webkit-scrollbar-thumb \{\
            background: #d1d5db;\
            border-radius: 10px;\
        \}\
        #assignment-list::-webkit-scrollbar-thumb:hover \{\
            background: #9ca3af;\
        \}\
\
        /* Calendar-specific styles */\
        .calendar-day \{\
            min-height: 100px;\
        \}\
        .calendar-day-empty \{\
            min-height: 100px;\
            background-color: #f9fafb; /* bg-gray-50 */\
        \}\
        \
        /* Simple transition for collapsible content */\
        .collapsible-content \{\
            max-height: 1000px;\
            overflow: hidden;\
            transition: max-height 0.3s ease-in-out;\
        \}\
        .collapsible-content.collapsed \{\
            max-height: 0;\
            padding-top: 0;\
            padding-bottom: 0;\
            margin-top: 0;\
        \}\
\
        /* AI Loading Modal */\
        .modal \{\
            transition: opacity 0.25s ease;\
        \}\
        .modal-content \{\
            transition: transform 0.25s ease;\
        \}\
        .spinner \{\
            border-top-color: #3498db;\
            animation: spin 1s linear infinite;\
        \}\
        @keyframes spin \{\
            to \{\
                transform: rotate(360deg);\
            \}\
        \}\
    </style>\
</head>\
<body class="h-full font-sans">\
\
    <div class="flex flex-col h-full">\
        <!-- Header -->\
        <header class="bg-blue-600 text-white shadow-md z-10">\
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">\
                <h1 class="text-3xl font-bold">My Assignment Tracker</h1>\
            </div>\
        </header>\
\
        <!-- Auth Status -->\
        <div id="auth-status" class="text-center p-2 bg-yellow-100 text-yellow-800">\
            Connecting to database...\
        </div>\
        <div id="user-id-display" class="text-center p-2 bg-gray-200 text-gray-700 text-sm hidden">\
            User ID: <span id="user-id" class="font-mono"></span>\
        </div>\
\
        <!-- Main Content -->\
        <main class="flex-grow max-w-7xl w-full mx-auto p-4 sm:p-6 lg:p-8 grid grid-cols-1 md:grid-cols-3 gap-6">\
\
            <!-- Form Container (Now Collapsible) -->\
            <section id="form-container" class="md:col-span-1 bg-white rounded-lg shadow-lg h-fit">\
                <!-- Collapsible Header -->\
                <div id="form-toggle-header" class="flex justify-between items-center p-6 cursor-pointer">\
                    <h2 class="text-2xl font-bold text-gray-800">Manage Assignments</h2>\
                    <span id="form-toggle-icon" class="text-2xl text-gray-500 transform transition-transform duration-300">&minus;</span>\
                </div>\
                \
                <!-- Collapsible Content -->\
                <div id="form-collapsible-content" class="collapsible-content px-6 pb-6">\
                    <!-- Tab Buttons -->\
                    <div class="border-b border-gray-200 mb-4">\
                        <nav class="-mb-px flex space-x-4" aria-label="Tabs">\
                            <button id="tab-add" class="tab-btn whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600">\
                                Add Assignment\
                            </button>\
                            <button id="tab-settings" class="tab-btn whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">\
                                Manage Subjects\
                            </button>\
                        </nav>\
                    </div>\
\
                    <!-- Add Assignment Form -->\
                    <form id="assignment-form" class="space-y-4">\
                        <div>\
                            <label for="assign-name" class="block text-sm font-medium text-gray-700 mb-1">Assignment Name</label>\
                            <input type="text" id="assign-name" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>\
                        </div>\
                        <div>\
                            <label for="assign-subject" class="block text-sm font-medium text-gray-700 mb-1">Subject</label>\
                            <select id="assign-subject" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>\
                                <option value="">Select a subject...</option>\
                            </select>\
                        </div>\
                        <div>\
                            <label for="assign-due-date" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>\
                            <input type="date" id="assign-due-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>\
                        </div>\
                        <button type="submit" id="add-assignment-btn" class="w-full bg-blue-600 text-white p-2 rounded-md font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:opacity-50" disabled>\
                            Add Assignment\
                        </button>\
                    </form>\
\
                    <!-- Settings View (Hidden by default) -->\
                    <div id="settings-view" class="hidden space-y-4">\
                        <div>\
                            <h3 class="text-lg font-medium text-gray-800 mb-2">Add New Subject</h3>\
                            <form id="add-subject-form" class="flex gap-2">\
                                <input type="text" id="new-subject-name" placeholder="Subject Name (e.g., Math)" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>\
                                <button type="submit" id="add-subject-btn" class="bg-green-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-green-700 transition duration-150" disabled>Add</button>\
                            </form>\
                        </div>\
                        <div>\
                            <h3 class="text-lg font-medium text-gray-800 mb-2">Your Subjects</h3>\
                            <div id="subject-settings-list" class="space-y-2 max-h-64 overflow-y-auto pr-2">\
                                <p id="no-subjects-msg" class="text-gray-500">No subjects added yet.</p>\
                                <!-- Subject list will be populated here -->\
                            </div>\
                        </div>\
                    </div>\
                </div>\
            </section>\
\
            <!-- Checklist Container -->\
            <section class="md:col-span-2 bg-white p-6 rounded-lg shadow-lg flex flex-col h-full">\
                <!-- View Header -->\
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-4">\
                    <h2 class="text-2xl font-bold text-gray-800">Upcoming Assignments</h2>\
                    <!-- View Switcher -->\
                    <div class="flex-shrink-0 flex gap-2 p-1 bg-gray-200 rounded-lg">\
                        <button id="view-list-btn" class="view-btn px-4 py-1 text-sm font-medium rounded-md bg-white text-blue-700 shadow">List</button>\
                        <button id="view-calendar-btn" class="view-btn px-4 py-1 text-sm font-medium rounded-md text-gray-700">Calendar</button>\
                    </div>\
                </div>\
                \
                <!-- Sort Controls (for list view) -->\
                <div id="sort-controls" class="flex flex-wrap gap-4 mb-4">\
                    <span>Sort by:</span>\
                    <button id="sort-by-date" class="sort-btn bg-blue-200 text-blue-800 px-4 py-1 rounded-full text-sm font-medium">Date</button>\
                    <button id="sort-by-subject" class="sort-btn bg-gray-200 text-gray-800 px-4 py-1 rounded-full text-sm font-medium">Subject</button>\
                </div>\
                \
                <!-- Assignment List -->\
                <div id="assignment-list-container" class="flex-grow h-64 md:h-[calc(100vh-20rem)]">\
                    <div id="assignment-list" class="h-full overflow-y-auto">\
                        <!-- Assignments will be dynamically added here -->\
                        <p id="loading-tasks" class="p-4 text-gray-500">Loading assignments...</p>\
                    </div>\
                </div>\
\
                <!-- Calendar View -->\
                <div id="calendar-view" class="hidden flex-grow h-64 md:h-[calc(100vh-20rem)] flex-col">\
                    <!-- Calendar content will be generated by JS -->\
                </div>\
            </section>\
        </main>\
    </div>\
\
    <!-- AI Modal -->\
    <div id="ai-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">\
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl transform scale-95">\
            <div class="flex items-center gap-4">\
                <div class="spinner w-8 h-8 border-4 border-gray-200 border-t-blue-500 rounded-full"></div>\
                <span id="ai-modal-text" class="text-lg font-medium text-gray-700">Thinking...</span>\
            </div>\
            <p id="ai-modal-error" class="text-red-500 text-sm mt-2 hidden"></p>\
        </div>\
    </div>\
\
    <!-- Firebase SDK -->\
    <script type="module">\
        // --- PWA Service Worker Registration ---\
        if ('serviceWorker' in navigator) \{\
            window.addEventListener('load', () => \{\
                navigator.serviceWorker.register('./sw.js')\
                    .then(registration => \{\
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);\
                    \})\
                    .catch(err => \{\
                        console.log('ServiceWorker registration failed: ', err);\
                    \});\
            \});\
        \}\
        // --- End PWA Registration ---\
\
        // Import Firebase modules\
        import \{ initializeApp \} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";\
        import \{ getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken \} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";\
        import \{ \
            getFirestore, \
            collection, \
            addDoc, \
            onSnapshot, \
            doc, \
            updateDoc, \
            setDoc, \
            query,\
            deleteDoc,\
            setLogLevel\
        \} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";\
\
        // --- Global State ---\
        let assignments = [];\
        let subjects = \{\};\
        let currentSort = 'date';\
        let currentView = 'list';\
        let calendarDate = new Date();\
        let userId = null;\
        let db = null;\
        let auth = null;\
        let assignmentsUnsubscribe = null;\
        let subjectsUnsubscribe = null;\
        let isFormCollapsed = false;\
\
        // --- DOM Elements ---\
        const list = document.getElementById('assignment-list');\
        const sortDateBtn = document.getElementById('sort-by-date');\
        const sortSubjectBtn = document.getElementById('sort-by-subject');\
        const loadingTasks = document.getElementById('loading-tasks');\
        const authStatus = document.getElementById('auth-status');\
        const userIdDisplay = document.getElementById('user-id-display');\
        const userIdEl = document.getElementById('user-id');\
        const viewListBtn = document.getElementById('view-list-btn');\
        const viewCalendarBtn = document.getElementById('view-calendar-btn');\
        const sortControls = document.getElementById('sort-controls');\
        const assignmentListContainer = document.getElementById('assignment-list-container');\
        const calendarView = document.getElementById('calendar-view');\
        const formToggleHeader = document.getElementById('form-toggle-header');\
        const formToggleIcon = document.getElementById('form-toggle-icon');\
        const formCollapsibleContent = document.getElementById('form-collapsible-content');\
        const tabAdd = document.getElementById('tab-add');\
        const tabSettings = document.getElementById('tab-settings');\
        const assignmentForm = document.getElementById('assignment-form');\
        const settingsView = document.getElementById('settings-view');\
        const addSubjectForm = document.getElementById('add-subject-form');\
        const newSubjectName = document.getElementById('new-subject-name');\
        const addSubjectBtn = document.getElementById('add-subject-btn');\
        const subjectSettingsList = document.getElementById('subject-settings-list');\
        const noSubjectsMsg = document.getElementById('no-subjects-msg');\
        const assignmentSubjectSelect = document.getElementById('assign-subject');\
        const addAssignmentBtn = document.getElementById('add-assignment-btn');\
        // AI Modal Elements\
        const aiModal = document.getElementById('ai-modal');\
        const aiModalText = document.getElementById('ai-modal-text');\
        const aiModalError = document.getElementById('ai-modal-error');\
\
\
        // --- Firebase Config ---\
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';\
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '\{\}');\
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;\
\
        /**\
         * Initializes Firebase and handles user authentication.\
         */\
        async function initFirebase() \{\
            if (!firebaseConfig.apiKey) \{\
                authStatus.textContent = "Error: Firebase configuration is missing.";\
                console.error("Firebase config is missing.");\
                return;\
            \}\
\
            try \{\
                setLogLevel('Debug');\
                const app = initializeApp(firebaseConfig);\
                db = getFirestore(app);\
                auth = getAuth(app);\
\
                onAuthStateChanged(auth, (user) => \{\
                    if (user) \{\
                        userId = user.uid;\
                        authStatus.textContent = "Database connected.";\
                        authStatus.classList.replace('bg-yellow-100', 'bg-green-100');\
                        authStatus.classList.replace('text-yellow-800', 'text-green-800');\
                        userIdEl.textContent = userId;\
                        userIdDisplay.classList.remove('hidden');\
                        addAssignmentBtn.disabled = false;\
                        addSubjectBtn.disabled = false;\
                        loadData(userId);\
                    \} else \{\
                        userId = null;\
                        authStatus.textContent = "Not authenticated. Please wait...";\
                        authStatus.classList.replace('bg-green-100', 'bg-yellow-100');\
                        authStatus.classList.replace('text-green-800', 'text-yellow-800');\
                        userIdDisplay.classList.add('hidden');\
                        addAssignmentBtn.disabled = true;\
                        addSubjectBtn.disabled = true;\
                        if (assignmentsUnsubscribe) assignmentsUnsubscribe();\
                        if (subjectsUnsubscribe) subjectsUnsubscribe();\
                        assignments = [];\
                        subjects = \{\};\
                        render();\
                    \}\
                \});\
\
                if (initialAuthToken) \{\
                    await signInWithCustomToken(auth, initialAuthToken);\
                \} else \{\
                    await signInAnonymously(auth);\
                \}\
\
            \} catch (error)\
            \{\
                console.error("Firebase initialization error:", error);\
                authStatus.textContent = `Error: $\{error.message\}`;\
                authStatus.classList.replace('bg-yellow-100', 'bg-red-100');\
                authStatus.classList.replace('text-yellow-800', 'text-red-800');\
            \}\
        \}\
\
        /**\
         * Sets up real-time listeners for assignments and subjects.\
         */\
        function loadData(uid) \{\
            if (!db) return;\
            if (assignmentsUnsubscribe) assignmentsUnsubscribe();\
            if (subjectsUnsubscribe) subjectsUnsubscribe();\
\
            // Listener for Assignments\
            const assignmentsRef = collection(db, 'artifacts', appId, 'users', uid, 'assignments');\
            assignmentsUnsubscribe = onSnapshot(query(assignmentsRef), (snapshot) => \{\
                assignments = snapshot.docs.map(doc => (\{ ...doc.data(), id: doc.id \}));\
                render();\
            \}, (error) => \{\
                console.error("Error fetching assignments:", error);\
                loadingTasks.textContent = "Error loading assignments.";\
            \});\
\
            // Listener for Subjects\
            const subjectsRef = collection(db, 'artifacts', appId, 'users', uid, 'subjects');\
            subjectsUnsubscribe = onSnapshot(query(subjectsRef), (snapshot) => \{\
                subjects = \{\};\
                snapshot.docs.forEach(doc => \{\
                    subjects[doc.id] = \{ ...doc.data(), id: doc.id \};\
                \});\
                populateSubjectDropdown();\
                renderSubjectSettings();\
                render();\
            \}, (error) => \{\
                console.error("Error fetching subjects:", error);\
            \});\
        \}\
\
        // --- Gemini API ---\
\
        /**\
         * Calls the Gemini API to break down a task.\
         * @param \{string\} assignmentName - The name of the assignment.\
         * @param \{string\} subjectName - The name of the subject.\
         * @returns \{Promise<Array<string>>\} A promise that resolves to an array of sub-task strings.\
         */\
        async function callGeminiAPI(assignmentName, subjectName) \{\
            const apiKey = ""; // Leave empty, will be handled by the environment\
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=$\{apiKey\}`;\
\
            const systemPrompt = `You are an academic assistant. Your job is to help a student break down a school assignment into small, manageable sub-tasks.\
Respond with a JSON object containing a single key "tasks", which is an array of strings.\
Do not return more than 7 tasks. The tasks should be short, actionable, and in a logical order.\
Example: \{"tasks": ["Research the topic", "Create an outline", "Write the introduction", "Draft body paragraphs", "Write the conclusion", "Proofread and edit"]\}\
`;\
            const userQuery = `Break down this assignment:\
Assignment: "$\{assignmentName\}"\
Subject: "$\{subjectName\}"`;\
\
            const payload = \{\
                contents: [\{ parts: [\{ text: userQuery \}] \}],\
                systemInstruction: \{\
                    parts: [\{ text: systemPrompt \}]\
                \},\
                generationConfig: \{\
                    responseMimeType: "application/json",\
                    responseSchema: \{\
                        type: "OBJECT",\
                        properties: \{\
                            "tasks": \{\
                                "type": "ARRAY",\
                                "items": \{ "type": "STRING" \}\
                            \}\
                        \},\
                    \}\
                \}\
            \};\
\
            // Implement exponential backoff for retries\
            let response;\
            let retries = 0;\
            const maxRetries = 3;\
            let delay = 1000;\
\
            while (retries < maxRetries) \{\
                try \{\
                    response = await fetch(apiUrl, \{\
                        method: 'POST',\
                        headers: \{ 'Content-Type': 'application/json' \},\
                        body: JSON.stringify(payload)\
                    \});\
\
                    if (response.ok) \{\
                        const result = await response.json();\
                        const candidate = result.candidates?.[0];\
                        if (candidate && candidate.content?.parts?.[0]?.text) \{\
                            const jsonText = candidate.content.parts[0].text;\
                            const parsedJson = JSON.parse(jsonText);\
                            return parsedJson.tasks || [];\
                        \}\
                    \}\
                    \
                    if (response.status === 429 || response.status >= 500) \{\
                        // Throttling or server error, wait and retry\
                        console.warn(`Gemini API error $\{response.status\}. Retrying in $\{delay\}ms...`);\
                        await new Promise(res => setTimeout(res, delay));\
                        delay *= 2; // Exponential backoff\
                        retries++;\
                    \} else \{\
                        // Other client-side error, don't retry\
                        const errorResult = await response.json();\
                        console.error("Gemini API error:", errorResult);\
                        throw new Error(errorResult.error?.message || "Failed to get response from AI.");\
                    \}\
\
                \} catch (error) \{\
                    console.error("Error calling Gemini API:", error);\
                    if (retries >= maxRetries - 1) \{\
                         throw error;\
                    \}\
                    await new Promise(res => setTimeout(res, delay));\
                    delay *= 2;\
                    retries++;\
                \}\
            \}\
            throw new Error("AI task breakdown failed after multiple retries.");\
        \}\
        \
        /**\
         * Shows the AI loading modal.\
         * @param \{string\} text - The text to display.\
         */\
        function showAIModal(text) \{\
            aiModalText.textContent = text || "Thinking...";\
            aiModalError.classList.add('hidden');\
            aiModal.classList.remove('opacity-0', 'pointer-events-none');\
        \}\
\
        /**\
         * Hides the AI loading modal.\
         */\
        function hideAIModal() \{\
            aiModal.classList.add('opacity-0', 'pointer-events-none');\
        \}\
        \
        /**\
         * Shows an error in the AI modal.\
         * @param \{string\} errorMsg - The error message to display.\
         */\
        function showAIModalError(errorMsg) \{\
            aiModalText.textContent = "Error";\
            aiModalError.textContent = errorMsg;\
            aiModalError.classList.remove('hidden');\
            // Hide after a few seconds\
            setTimeout(hideAIModal, 3000);\
        \}\
\
        // --- Render Functions ---\
\
        function render() \{\
            if (currentView === 'list') \{\
                renderList();\
            \} else \{\
                renderCalendar();\
            \}\
        \}\
\
        function renderList() \{\
            list.innerHTML = ''; \
\
            if (assignments.length === 0) \{\
                loadingTasks.textContent = "No assignments added yet. Add one using the form!";\
                list.appendChild(loadingTasks);\
                return;\
            \}\
\
            const sortedAssignments = [...assignments].sort((a, b) => \{\
                if (currentSort === 'date') \{\
                    return new Date(a.dueDate) - new Date(b.dueDate);\
                \} else \{\
                    return (subjects[a.subject]?.name || a.subject)\
                        .localeCompare(subjects[b.subject]?.name || b.subject);\
                \}\
            \});\
\
            const listContainer = document.createElement('div');\
            listContainer.className = "border border-gray-200 rounded-md divide-y divide-gray-200";\
\
            sortedAssignments.forEach(assignment => \{\
                const item = document.createElement('div');\
                item.className = 'assignment-item bg-white';\
                item.dataset.id = assignment.id;\
                \
                const subject = subjects[assignment.subject.toLowerCase()];\
                const color = subject ? subject.color : '#d1d5db';\
                const subjectName = subject ? subject.name : assignment.subject;\
                \
                let subtasksHTML = '';\
                // Check if subtasks exist and render them\
                if (assignment.subtasks && assignment.subtasks.length > 0) \{\
                    subtasksHTML = '<div class="subtask-list ml-12 pl-4 border-l-2 border-gray-200 space-y-2 py-3">';\
                    assignment.subtasks.forEach((subtask, index) => \{\
                        subtasksHTML += `\
                            <div class="subtask-item flex items-center gap-3">\
                                <input type="checkbox" data-subtask-index="$\{index\}" class="subtask-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500 cursor-pointer" $\{subtask.isComplete ? 'checked' : ''\}>\
                                <label class="text-sm $\{subtask.isComplete ? 'line-through text-gray-500' : 'text-gray-700'\}">$\{subtask.text\}</label>\
                            </div>\
                        `;\
                    \});\
                    subtasksHTML += '</div>';\
                \}\
\
                const mainTaskHTML = `\
                    <div class="main-task flex items-center gap-4 p-4 transition-all duration-150 $\{assignment.isComplete ? 'bg-gray-50' : ''\}" style="border-left: 5px solid $\{color\};">\
                        <input type="checkbox" class="task-checkbox h-5 w-5 text-blue-600 rounded-full focus:ring-blue-500 cursor-pointer" $\{assignment.isComplete ? 'checked' : ''\} $\{assignment.subtasks?.length > 0 ? 'disabled' : ''\}>\
                        <div class="assignment-details flex-grow">\
                            <strong class="text-lg $\{assignment.isComplete ? 'line-through text-gray-600' : 'text-gray-800'\}">$\{assignment.name\}</strong>\
                            <div class="text-sm">\
                                <span class="subject-name font-medium" style="color:$\{color\}">$\{subjectName\}</span> | \
                                <span class="due-date text-gray-500">Due: $\{new Date(assignment.dueDate + 'T00:00:00').toLocaleDateString()\}</span>\
                            </div>\
                        </div>\
                        $\{!assignment.subtasks ? `<button class="breakdown-btn text-xs bg-blue-100 text-blue-700 font-semibold px-3 py-1 rounded-full hover:bg-blue-200 transition-colors">\uc0\u10024  Break Down Task</button>` : ''\}\
                        <button class="delete-btn text-gray-400 hover:text-red-500 text-2xl font-bold" title="Delete Assignment">&times;</button>\
                    </div>\
                `;\
\
                item.innerHTML = mainTaskHTML + subtasksHTML;\
                listContainer.appendChild(item);\
            \});\
            list.appendChild(listContainer);\
        \}\
\
        function renderCalendar() \{\
            calendarView.innerHTML = ''; \
\
            const year = calendarDate.getFullYear();\
            const month = calendarDate.getMonth();\
            const monthName = calendarDate.toLocaleString('default', \{ month: 'long' \});\
            const daysInMonth = new Date(year, month + 1, 0).getDate();\
            const firstDayOfMonth = new Date(year, month, 1).getDay();\
            const today = new Date().toISOString().split('T')[0];\
\
            const header = document.createElement('div');\
            header.className = 'flex justify-between items-center mb-4';\
            header.innerHTML = `\
                <button id="calendar-prev" class="p-2 rounded-full hover:bg-gray-100">&larr;</button>\
                <h3 class="text-xl font-semibold">$\{monthName\} $\{year\}</h3>\
                <button id="calendar-next" class="p-2 rounded-full hover:bg-gray-100">&rarr;</button>\
            `;\
            calendarView.appendChild(header);\
\
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];\
            const dayHeader = document.createElement('div');\
            dayHeader.className = 'grid grid-cols-7 gap-1 text-center font-medium text-gray-600 text-sm';\
            daysOfWeek.forEach(day => \{\
                dayHeader.innerHTML += `<div>$\{day\}</div>`;\
            \});\
            calendarView.appendChild(dayHeader);\
\
            const grid = document.createElement('div');\
            grid.className = 'grid grid-cols-7 gap-1 border-t border-l border-gray-200 mt-2';\
            \
            for (let i = 0; i < firstDayOfMonth; i++) \{\
                grid.innerHTML += `<div class="calendar-day-empty border-r border-b border-gray-200"></div>`;\
            \}\
\
            for (let d = 1; d <= daysInMonth; d++) \{\
                const dayCell = document.createElement('div');\
                dayCell.className = 'calendar-day border-r border-b border-gray-200 p-2 overflow-y-auto';\
                const dateStr = `$\{year\}-$\{String(month + 1).padStart(2, '0')\}-$\{String(d).padStart(2, '0')\}`;\
                \
                const dayNum = document.createElement('span');\
                dayNum.className = 'text-sm font-medium';\
                dayNum.textContent = d;\
                if (dateStr === today) \{\
                    dayNum.classList.add('bg-blue-600', 'text-white', 'rounded-full', 'w-6', 'h-6', 'inline-block', 'text-center', 'leading-6');\
                \}\
                dayCell.appendChild(dayNum);\
\
                const assignmentsForDay = assignments.filter(a => a.dueDate === dateStr);\
                const assignmentsContainer = document.createElement('div');\
                assignmentsContainer.className = 'mt-1 space-y-1';\
\
                assignmentsForDay.forEach(a => \{\
                    const subject = subjects[a.subject.toLowerCase()];\
                    const color = subject ? subject.color : '#d1d5db';\
                    \
                    const assignmentPill = document.createElement('div');\
                    assignmentPill.className = 'text-xs p-1 rounded block truncate';\
                    if (a.isComplete) \{\
                        assignmentPill.classList.add('line-through', 'opacity-70');\
                    \}\
                    assignmentPill.style.backgroundColor = color;\
                    const hsl = color.match(/\\d+/g);\
                    const lightness = hsl ? parseInt(hsl[2]) : 50;\
                    assignmentPill.style.color = lightness > 65 ? '#1f2937' : '#ffffff';\
                    assignmentPill.textContent = a.name;\
                    assignmentsContainer.appendChild(assignmentPill);\
                \});\
\
                dayCell.appendChild(assignmentsContainer);\
                grid.appendChild(dayCell);\
            \}\
            calendarView.appendChild(grid);\
        \}\
\
        function populateSubjectDropdown() \{\
            assignmentSubjectSelect.innerHTML = '<option value="">Select a subject...</option>';\
            const sortedSubjectKeys = Object.keys(subjects).sort((a, b) => subjects[a].name.localeCompare(subjects[b].name));\
            sortedSubjectKeys.forEach(key => \{\
                const subject = subjects[key];\
                const option = document.createElement('option');\
                option.value = subject.id;\
                option.textContent = subject.name;\
                assignmentSubjectSelect.appendChild(option);\
            \});\
        \}\
\
        function renderSubjectSettings() \{\
            subjectSettingsList.innerHTML = '';\
            if (Object.keys(subjects).length === 0) \{\
                subjectSettingsList.appendChild(noSubjectsMsg);\
                return;\
            \}\
            Object.values(subjects).forEach(subject => \{\
                const item = document.createElement('div');\
                item.className = 'flex items-center justify-between gap-2 p-2 rounded-md bg-gray-50';\
                item.innerHTML = `\
                    <input type="color" value="$\{subject.color\}" data-subject="$\{subject.id\}" class="subject-color-picker w-8 h-8 p-0 border-none cursor-pointer rounded">\
                    <span class="flex-grow font-medium text-gray-700">$\{subject.name\}</span>\
                    <button data-subject="$\{subject.id\}" class="delete-subject-btn text-gray-400 hover:text-red-500 text-xl font-bold" title="Delete Subject">&times;</button>\
                `;\
                subjectSettingsList.appendChild(item);\
            \});\
        \}\
\
        // --- Event Handlers ---\
\
        async function handleAddSubject(e) \{\
            e.preventDefault();\
            if (!db || !userId) return;\
            const name = newSubjectName.value.trim();\
            if (!name) return;\
            const id = name.toLowerCase();\
            const newColor = `hsl($\{Math.random() * 360\}, 70%, 80%)`;\
            try \{\
                const subjectDocRef = doc(db, 'artifacts', appId, 'users', userId, 'subjects', id);\
                await setDoc(subjectDocRef, \{ name: name, color: newColor \});\
                newSubjectName.value = '';\
            \} catch (error) \{\
                console.error("Error adding subject:", error);\
            \}\
        \}\
\
        async function handleColorChange(e) \{\
            if (!db || !userId) return;\
            const id = e.target.dataset.subject;\
            const newColor = e.target.value;\
            try \{\
                const subjectDocRef = doc(db, 'artifacts', appId, 'users', userId, 'subjects', id);\
                await updateDoc(subjectDocRef, \{ color: newColor \});\
            \} catch (error) \{\
                console.error("Error updating color:", error);\
            \}\
        \}\
\
        async function handleDeleteSubject(e) \{\
            if (!db || !userId) return;\
            const id = e.target.dataset.subject;\
            try \{\
                const subjectDocRef = doc(db, 'artifacts', appId, 'users', userId, 'subjects', id);\
                await deleteDoc(subjectDocRef);\
            \} catch (error) \{\
                console.error("Error deleting subject:", error);\
            \}\
        \}\
\
        async function handleAddAssignment(e) \{\
            e.preventDefault();\
            if (!db || !userId) return;\
            const name = document.getElementById('assign-name').value;\
            const subjectId = assignmentSubjectSelect.value;\
            const dueDate = document.getElementById('assign-due-date').value;\
            if (!name || !subjectId || !dueDate) return;\
            const newAssignment = \{\
                name: name,\
                subject: subjectId,\
                dueDate: dueDate,\
                isComplete: false,\
                createdAt: new Date().toISOString(),\
                // subtasks: [] // Intentionally left empty on creation\
            \};\
            try \{\
                const assignmentsRef = collection(db, 'artifacts', appId, 'users', userId, 'assignments');\
                await addDoc(assignmentsRef, newAssignment);\
                assignmentForm.reset();\
            \} catch (error) \{\
                console.error("Error adding assignment:", error);\
            \}\
        \}\
\
        /**\
         * Handles clicks on the "Break Down Task" button.\
         */\
        async function handleBreakdownClick(itemId) \{\
            if (!db || !userId) return;\
            const assignment = assignments.find(a => a.id === itemId);\
            if (!assignment) return;\
            \
            const subjectName = subjects[assignment.subject]?.name || assignment.subject;\
\
            showAIModal(`Breaking down "$\{assignment.name\}"...`);\
            \
            try \{\
                const tasks = await callGeminiAPI(assignment.name, subjectName);\
                \
                if (tasks.length === 0) \{\
                    throw new Error("AI returned no tasks.");\
                \}\
\
                // Convert string array to subtask object array\
                const subtasks = tasks.map(text => (\{ text: text, isComplete: false \}));\
\
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'assignments', itemId);\
                await updateDoc(docRef, \{ subtasks: subtasks \});\
                \
                hideAIModal();\
\
            \} catch (error) \{\
                console.error("Failed to break down task:", error);\
                showAIModalError(error.message || "AI task failed.");\
            \}\
        \}\
\
        async function handleListClick(e) \{\
            const target = e.target;\
            const assignmentItem = target.closest('.assignment-item');\
            if (!assignmentItem || !db || !userId) return;\
\
            const itemId = assignmentItem.dataset.id;\
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'assignments', itemId);\
            const assignment = assignments.find(a => a.id === itemId);\
            if (!assignment) return;\
\
            // Handle main task checkbox\
            if (target.classList.contains('task-checkbox')) \{\
                // Only allow checking if there are no subtasks\
                if (!assignment.subtasks || assignment.subtasks.length === 0) \{\
                    try \{\
                        await updateDoc(docRef, \{ isComplete: !assignment.isComplete \});\
                    \} catch (error) \{\
                        console.error("Error updating assignment:", error);\
                    \}\
                \}\
            \}\
            \
            // Handle sub-task checkbox\
            if (target.classList.contains('subtask-checkbox')) \{\
                const subtaskIndex = parseInt(target.dataset.subtaskIndex);\
                const newSubtasks = [...assignment.subtasks];\
                newSubtasks[subtaskIndex].isComplete = !newSubtasks[subtaskIndex].isComplete;\
\
                // Check if all subtasks are now complete\
                const allSubtasksComplete = newSubtasks.every(task => task.isComplete);\
                \
                try \{\
                    // Update subtasks and main task completion status\
                    await updateDoc(docRef, \{ \
                        subtasks: newSubtasks,\
                        isComplete: allSubtasksComplete // Automatically complete main task\
                    \});\
                \} catch (error) \{\
                    console.error("Error updating subtask:", error);\
                \}\
            \}\
\
            // Handle delete button\
            if (target.classList.contains('delete-btn')) \{\
                try \{\
                    await deleteDoc(docRef);\
                \} catch (error) \{\
                    console.error("Error deleting assignment:", error);\
                \}\
            \}\
\
            // Handle "Break Down Task" button\
            if (target.classList.contains('breakdown-btn')) \{\
                handleBreakdownClick(itemId);\
            \}\
        \}\
\
        function handleSort(newSort) \{\
            currentSort = newSort;\
            if (newSort === 'date') \{\
                sortDateBtn.classList.add('bg-blue-200', 'text-blue-800');\
                sortDateBtn.classList.remove('bg-gray-200', 'text-gray-800');\
                sortSubjectBtn.classList.add('bg-gray-200', 'text-gray-800');\
                sortSubjectBtn.classList.remove('bg-blue-200', 'text-blue-800');\
            \} else \{\
                sortSubjectBtn.classList.add('bg-blue-200', 'text-blue-800');\
                sortSubjectBtn.classList.remove('bg-gray-200', 'text-gray-800');\
                sortDateBtn.classList.add('bg-gray-200', 'text-gray-800');\
                sortDateBtn.classList.remove('bg-blue-200', 'text-blue-800');\
            \}\
            renderList();\
        \}\
\
        function handleViewSwitch(view) \{\
            currentView = view;\
            if (view === 'list') \{\
                assignmentListContainer.classList.remove('hidden');\
                sortControls.classList.remove('hidden');\
                calendarView.classList.add('hidden');\
                viewListBtn.classList.add('bg-white', 'text-blue-700', 'shadow');\
                viewListBtn.classList.remove('text-gray-700');\
                viewCalendarBtn.classList.remove('bg-white', 'text-blue-700', 'shadow');\
                viewCalendarBtn.classList.add('text-gray-700');\
            \} else \{\
                assignmentListContainer.classList.add('hidden');\
                sortControls.classList.add('hidden');\
                calendarView.classList.remove('hidden');\
                viewCalendarBtn.classList.add('bg-white', 'text-blue-700', 'shadow');\
                viewCalendarBtn.classList.remove('text-gray-700');\
                viewListBtn.classList.remove('bg-white', 'text-blue-700', 'shadow');\
                viewListBtn.classList.add('text-gray-700');\
            \}\
            render();\
        \}\
\
        function handleCalendarNav(e) \{\
            if (e.target.id === 'calendar-prev') \{\
                calendarDate.setMonth(calendarDate.getMonth() - 1);\
                renderCalendar();\
            \}\
            if (e.target.id === 'calendar-next') \{\
                calendarDate.setMonth(calendarDate.getMonth() + 1);\
                renderCalendar();\
            \}\
        \}\
\
        function handleToggleForm() \{\
            isFormCollapsed = !isFormCollapsed;\
            formCollapsibleContent.classList.toggle('collapsed');\
            if (isFormCollapsed) \{\
                formToggleIcon.style.transform = 'rotate(180deg)';\
                formToggleIcon.innerHTML = '+';\
            \} else \{\
                formToggleIcon.style.transform = 'rotate(0deg)';\
                formToggleIcon.innerHTML = '&minus;';\
            \}\
        \}\
\
        function handleTabSwitch(tab) \{\
            if (tab === 'add') \{\
                assignmentForm.classList.remove('hidden');\
                settingsView.classList.add('hidden');\
                tabAdd.classList.add('border-blue-500', 'text-blue-600');\
                tabAdd.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');\
                tabSettings.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');\
                tabSettings.classList.remove('border-blue-500', 'text-blue-600');\
            \} else \{\
                assignmentForm.classList.add('hidden');\
                settingsView.classList.remove('hidden');\
                tabSettings.classList.add('border-blue-500', 'text-blue-600');\
                tabSettings.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');\
                tabAdd.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');\
                tabAdd.classList.remove('border-blue-500', 'text-blue-600');\
            \}\
        \}\
\
        // --- Event Listeners ---\
        document.addEventListener('DOMContentLoaded', initFirebase);\
        \
        list.addEventListener('click', handleListClick);\
        sortDateBtn.addEventListener('click', () => handleSort('date'));\
        sortSubjectBtn.addEventListener('click', () => handleSort('subject'));\
        viewListBtn.addEventListener('click', () => handleViewSwitch('list'));\
        viewCalendarBtn.addEventListener('click', () => handleViewSwitch('calendar'));\
        calendarView.addEventListener('click', handleCalendarNav);\
\
        assignmentForm.addEventListener('submit', handleAddAssignment);\
        formToggleHeader.addEventListener('click', handleToggleForm);\
        tabAdd.addEventListener('click', () => handleTabSwitch('add'));\
        tabSettings.addEventListener('click', () => handleTabSwitch('settings'));\
        \
        addSubjectForm.addEventListener('submit', handleAddSubject);\
        subjectSettingsList.addEventListener('change', (e) => \{\
            if (e.target.classList.contains('subject-color-picker')) \{\
                handleColorChange(e);\
            \}\
        \});\
        subjectSettingsList.addEventListener('click', (e) => \{\
            if (e.target.classList.contains('delete-subject-btn')) \{\
                handleDeleteSubject(e);\
            \}\
        \});\
\
    </script>\
</body>\
</html>}